<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hurdo+ Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724; /* dark navy */
      --card:#0f1724;
      --surface:#111827;
      --muted:#94a3b8;
      --accent:#6ea8fe;
      --accent-2:#ff7b9c;
      --glass: rgba(255,255,255,0.04);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071029 0%, #071b2a 60%);color:#e6eef8}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:36px}
    .panel{width:100%;max-width:920px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:26px;box-shadow:0 10px 30px rgba(2,6,23,0.6);backdrop-filter: blur(6px);}
    h1{margin:0 0 10px;font-size:20px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
    .subtitle{color:var(--muted);font-size:13px}

    .content{display:grid;grid-template-columns:1fr 360px;gap:18px}
    form{background:var(--glass);padding:14px;border-radius:12px}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    input[type='text'], input[type='file']{width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
    .btn{display:inline-flex;align-items:center;gap:10px;background:linear-gradient(90deg,var(--accent),#7bd1ff);color:#042038;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .list{max-height:520px;overflow:auto;padding:10px;background:rgba(255,255,255,0.02);border-radius:12px}
    .item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));margin-bottom:10px}
    .thumb{width:84px;height:64px;border-radius:8px;overflow:hidden;background:linear-gradient(180deg,#0b1220,#08141a);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px}
    .meta{flex:1}
    .meta h4{margin:0;font-size:15px}
    .meta p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .controls{display:flex;flex-direction:column;gap:8px}
    .controls button{border-radius:10px;padding:8px 10px;border:0;background:#0b1220;color:var(--accent-2);cursor:pointer}
    audio{width:220px;height:36px}

    @media (max-width:900px){
      .content{grid-template-columns:1fr}
      audio{width:160px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="top">
        <div class="brand">
          <div class="logo">H+</div>
          <div>
            <h1>Hurdo+ Admin</h1>
            <div class="subtitle">Upload sounds & artwork — files are stored in Supabase buckets</div>
          </div>
        </div>
  <div class="subtitle">Local admin • Open <strong>http://localhost:4000</strong></div>
      </div>

      <div class="content">
        <div>
          <form id="uploadForm">
            <label for="title">Title</label>
            <input id="title" name="title" type="text" placeholder="Rainy Night" required />

            <label for="sound" style="margin-top:12px">Sound file</label>
            <input id="sound" type="file" name="sound" accept="audio/*" required />

            <label for="art" style="margin-top:12px">Art image (optional)</label>
            <input id="art" type="file" name="art" accept="image/*" />

            <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
              <button class="btn" type="submit">Upload sound</button>
              <div class="subtitle" id="status">Ready</div>
            </div>
          </form>

          <h3 style="margin-top:18px">All Sounds</h3>
          <div class="list" id="list">Loading...</div>
        </div>

        <aside>
          <div style="padding:12px;background:rgba(255,255,255,0.02);border-radius:12px">
            <h4 style="margin:0 0 8px">About</h4>
            <p class="subtitle" style="margin:0">Use this page to upload new sounds and artwork. Uploaded content is served by the Hurdo backend.</p>
          </div>
            <div style="margin-top:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:12px">
              <h4 style="margin:0 0 8px">Storage</h4>
              <p class="subtitle" style="margin:0 0 8px">Mode: <strong id="storageType">Supabase</strong></p>
              <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
                <input id="adminToken" type="text" placeholder="Admin token (optional)" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit" />
                <button class="btn" id="makePublicBtn" style="background:linear-gradient(90deg,#ffd1e0,#ffb3c7);color:#2b0720;padding:8px;">Make buckets public</button>
              </div>
              <div class="subtitle" id="storageMsg" style="margin-top:8px">Using Supabase storage: uploaded files will use public URLs for playback.</div>
            </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    const base = '';
    const status = document.getElementById('status');
  const storageTypeEl = document.getElementById('storageType');
  const storageMsg = document.getElementById('storageMsg');
  const makePublicBtn = document.getElementById('makePublicBtn');
  const adminTokenInput = document.getElementById('adminToken');

    // URL resolver: stored values in soundFileId/artFileId are expected to be public URLs from Supabase
    function asUrl(raw){
      if(!raw) return '';
      if(typeof raw !== 'string') raw = String(raw);
      if(raw.startsWith('http')) return raw;
      // Non-URL values are no longer supported since GridFS has been removed.
      return '';
    }

    async function load(){
      status.textContent = 'Loading...';
      try{
        const res = await fetch(base + '/sounds');
        if(!res.ok) throw new Error('Failed to fetch');
        const items = await res.json();
        const list = document.getElementById('list');
  // Supabase-first: assume public URLs when provided
  storageTypeEl.textContent = 'Supabase (preferred)';
  storageMsg.textContent = 'Using Supabase public URLs for playback. Ensure uploads used the supabase service key so URLs are public.';

        if(!items || !items.length){ list.innerHTML = '<div class="subtitle">No sounds uploaded yet</div>'; status.textContent='Ready'; return }

        list.innerHTML = items.map(i=>{
          const artSrc = asUrl(i.artFileId);
          const soundSrc = asUrl(i.soundFileId);
          const thumb = artSrc ? `<img src="${artSrc}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">` : 'No image';
      const audioTag = soundSrc ? `<audio controls src="${soundSrc}"></audio>` : 'No audio';
      // show a delete button that sends admin token if present
      return `
          <div class="item">
            <div class="thumb">${thumb}</div>
            <div class="meta">
              <h4>${escapeHtml(i.title || '')}</h4>
              <p>${new Date(i.createdAt).toLocaleString()}</p>
            </div>
            <div class="controls">
              ${audioTag}
        <button onclick="del('${i._id}')">Delete</button>
            </div>
          </div>`;
        }).join('');
        status.textContent='Ready';
      }catch(e){ console.error(e); status.textContent='Failed to load' }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    async function del(id){
      if(!confirm('Delete this sound?')) return;
      const token = adminTokenInput.value || undefined;
      try{
        const headers = token ? {'x-admin-token': token} : {};
        const res = await fetch(base + '/sounds/'+id,{method:'DELETE', headers});
        if(!res.ok) throw new Error('Delete failed');
      }catch(e){console.error(e); alert('Delete failed');} finally{ load(); }
    }

    // preview selected files
    const soundInput = document.getElementById('sound');
    const artInput = document.getElementById('art');
    const previewArea = document.createElement('div');
    previewArea.style.marginTop = '10px';
    document.getElementById('uploadForm').appendChild(previewArea);
    function updatePreview(){
      const s = soundInput.files[0];
      const a = artInput.files[0];
      previewArea.innerHTML = '';
      if(a){ const url = URL.createObjectURL(a); previewArea.innerHTML += `<div style="margin-bottom:8px"><strong>Art preview</strong><div style="width:120px;height:80px;margin-top:6px"><img src="${url}" style="width:100%;height:100%;object-fit:cover"/></div></div>` }
      if(s){ const url = URL.createObjectURL(s); previewArea.innerHTML += `<div><strong>Sound preview</strong><div style="margin-top:6px"><audio controls src="${url}"></audio></div></div>` }
    }
    soundInput.addEventListener('change', updatePreview);
    artInput.addEventListener('change', updatePreview);

    document.getElementById('uploadForm').onsubmit = async e=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      status.textContent='Uploading...';
      try{
        const token = adminTokenInput.value || undefined;
        const headers = token ? {'x-admin-token': token} : {};
        const res = await fetch(base + '/sounds',{method:'POST',body:fd, headers});
        if(!res.ok) throw new Error('Upload failed');
        e.target.reset();
        previewArea.innerHTML = '';
        await load();
      }catch(err){ console.error(err); status.textContent='Upload error'; alert('Upload failed'); }
    }

    makePublicBtn.addEventListener('click', async ()=>{
      const token = adminTokenInput.value || undefined;
      storageMsg.textContent = 'Making buckets public...';
      try{
        const headers = token ? {'x-admin-token': token, 'Content-Type': 'application/json'} : {'Content-Type': 'application/json'};
        const res = await fetch(base + '/supabase/make-public',{method:'POST', headers});
        if(!res.ok) throw new Error('Failed');
        storageMsg.textContent = 'Buckets are now public (or already public).';
        setTimeout(()=>load(),800);
      }catch(e){ console.error(e); storageMsg.textContent = 'Failed to make public'; alert('Make-public failed'); }
    });

    load();
  </script>
</body>
</html>
